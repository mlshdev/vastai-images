name: Build and Publish ComfyUI-Jupyter-SSH Image

on:
  workflow_dispatch:
    inputs:
      comfyui_ref:
        description: "ComfyUI git ref (branch, tag, or commit)"
        required: false
        default: "master"
      python_version:
        description: "Python version for the virtual environment"
        required: false
        default: "3.12"
      push_to_ghcr:
        description: "Push to GitHub Container Registry"
        required: false
        default: true
        type: boolean
      push_to_dockerhub:
        description: "Push to Docker Hub"
        required: false
        default: true
        type: boolean
      image_tag:
        description: "Image tag (leave empty for auto-generated)"
        required: false
        default: ""

env:
  IMAGE_NAME: comfyui-jupyter-ssh
  DOCKERFILE_PATH: derivatives/comfyui-jupyter-ssh/Dockerfile
  CONTEXT_PATH: derivatives/comfyui-jupyter-ssh

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free up disk space
        uses: endersonmenezes/free-disk-space@v3
        with:
          remove_android: true
          remove_dotnet: true
          remove_haskell: true
          remove_tool_cache: false
          remove_swap: true
          remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
          remove_packages_one_command: true
          remove_folders: "/usr/share/swift /usr/share/az* /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle"
          rm_cmd: "rmz" # Use 'rmz' for faster deletion (default: 'rm')
          rmz_version: "3.1.1" # Required when rm_cmd is 'rmz'
          testing: false

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            # Generate tag from date and short SHA
            TAG="$(date +'%Y%m%d')-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"

      - name: Log in to GitHub Container Registry
        if: ${{ github.event.inputs.push_to_ghcr == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        if: ${{ github.event.inputs.push_to_dockerhub == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ github.event.inputs.push_to_ghcr == 'true' && format('ghcr.io/{0}/{1}', github.repository_owner, env.IMAGE_NAME) || '' }}
            ${{ github.event.inputs.push_to_dockerhub == 'true' && secrets.DOCKERHUB_USERNAME != '' && format('{0}/{1}', secrets.DOCKERHUB_USERNAME, env.IMAGE_NAME) || '' }}
          tags: |
            type=raw,value=${{ steps.tag.outputs.tag }}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.CONTEXT_PATH }}
          file: ${{ env.DOCKERFILE_PATH }}
          platforms: linux/amd64
          push: ${{ (github.event.inputs.push_to_ghcr == 'true') || (github.event.inputs.push_to_dockerhub == 'true' && secrets.DOCKERHUB_USERNAME != '') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            COMFYUI_REF=${{ github.event.inputs.comfyui_ref }}
            PYTHON_VERSION=${{ github.event.inputs.python_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image info
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ComfyUI Ref:** ${{ github.event.inputs.comfyui_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Version:** ${{ github.event.inputs.python_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published To" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.push_to_ghcr }}" == "true" ]; then
            echo "- GitHub Container Registry: \`ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.push_to_dockerhub }}" == "true" ]; then
            echo "- Docker Hub: \`${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          fi
